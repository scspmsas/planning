<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning de Projet</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo, useRef } = React;

        const translations = {
            fr: {
                projectTitle: 'Planning de Projet',
                type: 'Type',
                description: 'Description',
                start: 'Début',
                end: 'Fin',
                action: 'Action',
                story: 'Story',
                task: 'Task',
                exportJSON: 'Exporter JSON',
                importJSON: 'Importer JSON',
                exportImage: 'Exporter Image',
                addTask: 'Ajouter tâche',
                taskCount: 'tâche(s)',
                year: 'Année',
                newTask: 'Nouvelle tâche',
                errorJSON: 'Erreur lors de la lecture du fichier JSON.',
                hideColumns: 'Masquer colonnes',
                showColumns: 'Afficher colonnes',
                view: 'Vue',
                file: 'Fichier',
                oneYear: '1 an',
                twoYears: '2 ans',
                threeYears: '3 ans',
                color: 'Couleur',
                customColor: 'Couleur personnalisée',
                assignee: 'Assigné à',
                manageTeam: 'Gérer l\'équipe',
                addMember: 'Ajouter membre',
                memberName: 'Nom du membre',
                deleteMember: 'Supprimer membre',
                noAssignee: 'Non assigné',
                filterByMember: 'Filtrer par membre',
                allMembers: 'Tous les membres',
                statistics: 'Statistiques',
                projectDuration: 'Durée du projet',
                workloadByWeek: 'Charge de travail par semaine',
                overdueTasks: 'Tâches en retard',
                progressChart: 'Progression du projet',
                status: 'Statut',
                todo: 'À faire',
                inProgress: 'En cours',
                completed: 'Terminé',
                blocked: 'Bloqué',
                totalTasks: 'Total des tâches',
                completionRate: 'Taux de complétion',
                days: 'jours',
                weeks: 'semaines',
                tasksActive: 'tâche(s) active(s)',
                noOverdue: 'Aucune tâche en retard',
                startDate: 'Date de début',
                endDate: 'Date de fin',
                months: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre']
            },
            en: {
                projectTitle: 'Project Planning',
                type: 'Type',
                description: 'Description',
                start: 'Start',
                end: 'End',
                action: 'Action',
                story: 'Story',
                task: 'Task',
                exportJSON: 'Export JSON',
                importJSON: 'Import JSON',
                exportImage: 'Export Image',
                addTask: 'Add Task',
                taskCount: 'task(s)',
                year: 'Year',
                newTask: 'New task',
                errorJSON: 'Error reading JSON file.',
                hideColumns: 'Hide columns',
                showColumns: 'Show columns',
                view: 'View',
                file: 'File',
                oneYear: '1 year',
                twoYears: '2 years',
                threeYears: '3 years',
                color: 'Color',
                customColor: 'Custom color',
                assignee: 'Assigned to',
                manageTeam: 'Manage team',
                addMember: 'Add member',
                memberName: 'Member name',
                deleteMember: 'Delete member',
                noAssignee: 'Unassigned',
                filterByMember: 'Filter by member',
                allMembers: 'All members',
                statistics: 'Statistics',
                projectDuration: 'Project duration',
                workloadByWeek: 'Workload by week',
                overdueTasks: 'Overdue tasks',
                progressChart: 'Project progress',
                status: 'Status',
                todo: 'To do',
                inProgress: 'In progress',
                completed: 'Completed',
                blocked: 'Blocked',
                totalTasks: 'Total tasks',
                completionRate: 'Completion rate',
                days: 'days',
                weeks: 'weeks',
                tasksActive: 'active task(s)',
                noOverdue: 'No overdue tasks',
                startDate: 'Start date',
                endDate: 'End date',
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
            },
            ro: {
                projectTitle: 'Planificare Proiect',
                type: 'Tip',
                description: 'Descriere',
                start: 'Început',
                end: 'Sfârșit',
                action: 'Acțiune',
                story: 'Story',
                task: 'Task',
                exportJSON: 'Exportă JSON',
                importJSON: 'Importă JSON',
                exportImage: 'Exportă Imagine',
                addTask: 'Adaugă task',
                taskCount: 'task-uri',
                year: 'An',
                newTask: 'Task nou',
                errorJSON: 'Eroare la citirea fișierului JSON.',
                hideColumns: 'Ascunde coloanele',
                showColumns: 'Arată coloanele',
                view: 'Vedere',
                file: 'Fișier',
                oneYear: '1 an',
                twoYears: '2 ani',
                threeYears: '3 ani',
                color: 'Culoare',
                customColor: 'Culoare personalizată',
                assignee: 'Atribuit',
                manageTeam: 'Gestionează echipa',
                addMember: 'Adaugă membru',
                memberName: 'Nume membru',
                deleteMember: 'Șterge membru',
                noAssignee: 'Neatribuit',
                filterByMember: 'Filtrează după membru',
                allMembers: 'Toți membrii',
                statistics: 'Statistici',
                projectDuration: 'Durata proiectului',
                workloadByWeek: 'Sarcină de lucru pe săptămână',
                overdueTasks: 'Taskuri întârziate',
                progressChart: 'Progresul proiectului',
                status: 'Status',
                todo: 'De făcut',
                inProgress: 'În progres',
                completed: 'Finalizat',
                blocked: 'Blocat',
                totalTasks: 'Total taskuri',
                completionRate: 'Rată de finalizare',
                days: 'zile',
                weeks: 'săptămâni',
                tasksActive: 'task(uri) activ(e)',
                noOverdue: 'Niciun task întârziat',
                startDate: 'Data început',
                endDate: 'Data sfârșit',
                months: ['Ianuarie', 'Februarie', 'Martie', 'Aprilie', 'Mai', 'Iunie', 'Iulie', 'August', 'Septembrie', 'Octombrie', 'Noiembrie', 'Decembrie']
            }
        };

        // Icônes SVG
        const Calendar = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Palette = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="13.5" cy="6.5" r=".5"></circle>
                <circle cx="17.5" cy="10.5" r=".5"></circle>
                <circle cx="8.5" cy="7.5" r=".5"></circle>
                <circle cx="6.5" cy="12.5" r=".5"></circle>
                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path>
            </svg>
        );

        const ChevronLeft = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        );

        const ChevronRight = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Upload = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const FileDown = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="12" y1="18" x2="12" y2="12"></line>
                <polyline points="9 15 12 18 15 15"></polyline>
            </svg>
        );

        const Eye = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        const EyeOff = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        );

        const Menu = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Users = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const UserPlus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
        );

        const Filter = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        );

        const BarChart = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
            </svg>
        );

        const ProjectPlanner = () => {
            const [currentYear, setCurrentYear] = useState(2024);
            const [language, setLanguage] = useState('fr');
            const [projectTitle, setProjectTitle] = useState(translations['fr'].projectTitle);
            const fileInputRef = useRef(null);
            const [showColumns, setShowColumns] = useState(true);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [fileMenuOpen, setFileMenuOpen] = useState(false);
            const [yearView, setYearView] = useState(1);
            const [colorPickerOpen, setColorPickerOpen] = useState(null);
            const [teamMenuOpen, setTeamMenuOpen] = useState(false);
            const [filterMenuOpen, setFilterMenuOpen] = useState(false);
            const [selectedMemberFilter, setSelectedMemberFilter] = useState('all');
            const [newMemberName, setNewMemberName] = useState('');
            const [statsMenuOpen, setStatsMenuOpen] = useState(false);
            
            // Membres d'équipe
            const [teamMembers, setTeamMembers] = useState([
                { id: 1, name: 'Alice Dupont' },
                { id: 2, name: 'Bob Martin' },
                { id: 3, name: 'Claire Bernard' }
            ]);
            
            // Palette de couleurs prédéfinies
            const predefinedColors = [
                '#60A5FA', // Bleu
                '#93C5FD', // Bleu clair
                '#34D399', // Vert
                '#A78BFA', // Violet
                '#F87171', // Rouge
                '#FBBF24', // Jaune
                '#FB923C', // Orange
                '#EC4899', // Rose
                '#10B981', // Vert émeraude
                '#8B5CF6', // Violet foncé
                '#EF4444', // Rouge vif
                '#14B8A6'  // Turquoise
            ];
            
            const [tasks, setTasks] = useState([
                {
                    id: 1,
                    type: 'Story',
                    description: 'UI and Client improvements',
                    startDate: null,
                    endDate: null,
                    color: '#60A5FA',
                    assigneeId: null,
                    status: 'inProgress'
                },
                {
                    id: 2,
                    type: 'Task',
                    description: 'Development',
                    startDate: '2024-09-23',
                    endDate: '2024-10-21',
                    color: '#93C5FD',
                    assigneeId: 1,
                    status: 'completed'
                },
                {
                    id: 3,
                    type: 'Task',
                    description: 'IAT - QA testing',
                    startDate: '2024-10-22',
                    endDate: '2024-11-04',
                    color: '#93C5FD',
                    assigneeId: 2,
                    status: 'inProgress'
                },
                {
                    id: 4,
                    type: 'Task',
                    description: 'UAT',
                    startDate: '2024-11-05',
                    endDate: '2024-11-14',
                    color: '#93C5FD',
                    assigneeId: 3,
                    status: 'todo'
                }
            ]);

            const getWeeksInYear = (year) => {
                const lastDay = new Date(year, 11, 31);
                return Math.ceil((lastDay - new Date(year, 0, 1)) / (7 * 24 * 60 * 60 * 1000));
            };

            const getWeekNumber = (date) => {
                const d = new Date(date);
                const yearStart = new Date(d.getFullYear(), 0, 1);
                return Math.ceil((d - yearStart) / (7 * 24 * 60 * 60 * 1000));
            };

            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };

            const getInitials = (name) => {
                if (!name) return '';
                const parts = name.trim().split(' ');
                if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            };

            const addTeamMember = () => {
                if (!newMemberName.trim()) return;
                const newMember = {
                    id: Date.now(),
                    name: newMemberName.trim()
                };
                setTeamMembers([...teamMembers, newMember]);
                setNewMemberName('');
            };

            const deleteTeamMember = (id) => {
                setTeamMembers(teamMembers.filter(member => member.id !== id));
                // Retirer l'assignation des tâches qui avaient ce membre
                setTasks(tasks.map(task => 
                    task.assigneeId === id ? { ...task, assigneeId: null } : task
                ));
            };

            const getMemberById = (id) => {
                return teamMembers.find(member => member.id === id);
            };

            const getFilteredTasks = () => {
                if (selectedMemberFilter === 'all') return tasks;
                if (selectedMemberFilter === 'unassigned') return tasks.filter(task => !task.assigneeId);
                return tasks.filter(task => task.assigneeId === parseInt(selectedMemberFilter));
            };

            const filteredTasks = getFilteredTasks();

            // Fonctions de statistiques
            const calculateProjectDuration = () => {
                const tasksWithDates = tasks.filter(t => t.startDate && t.endDate);
                if (tasksWithDates.length === 0) return { days: 0, weeks: 0 };
                
                const startDates = tasksWithDates.map(t => new Date(t.startDate));
                const endDates = tasksWithDates.map(t => new Date(t.endDate));
                
                const projectStart = new Date(Math.min(...startDates));
                const projectEnd = new Date(Math.max(...endDates));
                
                const diffTime = Math.abs(projectEnd - projectStart);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffWeeks = Math.ceil(diffDays / 7);
                
                return { 
                    days: diffDays, 
                    weeks: diffWeeks,
                    startDate: projectStart,
                    endDate: projectEnd
                };
            };

            const calculateWorkloadByWeek = () => {
                const workload = {};
                
                tasks.forEach(task => {
                    if (!task.startDate || !task.endDate) return;
                    
                    const start = new Date(task.startDate);
                    const end = new Date(task.endDate);
                    
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 7)) {
                        const weekKey = `${d.getFullYear()}-W${getWeekNumber(d)}`;
                        workload[weekKey] = (workload[weekKey] || 0) + 1;
                    }
                });
                
                return workload;
            };

            const getOverdueTasks = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return tasks.filter(task => {
                    if (!task.endDate || task.status === 'completed') return false;
                    const endDate = new Date(task.endDate);
                    return endDate < today;
                });
            };

            const calculateProgress = () => {
                const totalTasks = tasks.filter(t => t.type === 'Task').length;
                if (totalTasks === 0) return { completed: 0, total: 0, percentage: 0 };
                
                const completedTasks = tasks.filter(t => t.type === 'Task' && t.status === 'completed').length;
                const percentage = Math.round((completedTasks / totalTasks) * 100);
                
                return { completed: completedTasks, total: totalTasks, percentage };
            };

            const getStatusCount = () => {
                return {
                    todo: tasks.filter(t => t.status === 'todo').length,
                    inProgress: tasks.filter(t => t.status === 'inProgress').length,
                    completed: tasks.filter(t => t.status === 'completed').length,
                    blocked: tasks.filter(t => t.status === 'blocked').length
                };
            };

            const generateWeekColumns = () => {
                const weeks = [];
                const t = translations[language];
                
                for (let yearOffset = 0; yearOffset < yearView; yearOffset++) {
                    const year = currentYear + yearOffset;
                    const totalWeeks = getWeeksInYear(year);
                    
                    for (let week = 1; week <= totalWeeks; week++) {
                        const date = new Date(year, 0, 1 + (week - 1) * 7);
                        const monthIndex = date.getMonth();
                        const month = t.months[monthIndex];
                        weeks.push({ week, month, year });
                    }
                }
                
                return weeks;
            };

            const getFirstTaskDate = () => {
                const dates = filteredTasks.filter(task => task.startDate).map(task => new Date(task.startDate));
                if (dates.length === 0) return null;
                return new Date(Math.min(...dates));
            };

            const getFilteredWeekColumns = () => {
                const allWeeks = generateWeekColumns();
                const firstDate = getFirstTaskDate();
                
                if (!firstDate) return allWeeks;
                
                const firstYear = firstDate.getFullYear();
                const firstWeek = getWeekNumber(firstDate);
                
                return allWeeks.filter(col => {
                    if (col.year > firstYear) return true;
                    if (col.year < firstYear) return false;
                    return col.week >= firstWeek;
                });
            };

            const weekColumns = useMemo(() => getFilteredWeekColumns(), [currentYear, filteredTasks, language, yearView]);

            const addTask = () => {
                const startDate = new Date(currentYear, 0, 1);
                const endDate = new Date(currentYear, 0, 28);
                const t = translations[language];
                const newTask = {
                    id: Date.now(),
                    type: 'Task',
                    description: t.newTask,
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0],
                    color: '#60A5FA',
                    assigneeId: null,
                    status: 'todo'
                };
                setTasks([...tasks, newTask]);
            };

            const deleteTask = (id) => {
                setTasks(tasks.filter(task => task.id !== id));
            };

            const updateTask = (id, field, value) => {
                setTasks(tasks.map(task => task.id === id ? { ...task, [field]: value } : task));
            };

            const getStoryDates = (storyIndex) => {
                const storyTasks = [];
                for (let i = storyIndex + 1; i < filteredTasks.length; i++) {
                    if (filteredTasks[i].type === 'Story') break;
                    if (filteredTasks[i].type === 'Task') storyTasks.push(filteredTasks[i]);
                }

                if (storyTasks.length === 0) return { startDate: null, endDate: null };

                const startDates = storyTasks.map(t => new Date(t.startDate)).filter(d => !isNaN(d));
                const endDates = storyTasks.map(t => new Date(t.endDate)).filter(d => !isNaN(d));

                if (startDates.length === 0 || endDates.length === 0) return { startDate: null, endDate: null };

                const minStart = new Date(Math.min(...startDates));
                const maxEnd = new Date(Math.max(...endDates));

                return {
                    startDate: minStart.toISOString().split('T')[0],
                    endDate: maxEnd.toISOString().split('T')[0]
                };
            };

            const getStoryDatesFromList = (taskList, storyIndex) => {
                const storyTasks = [];
                for (let i = storyIndex + 1; i < taskList.length; i++) {
                    if (taskList[i].type === 'Story') break;
                    if (taskList[i].type === 'Task') storyTasks.push(taskList[i]);
                }

                if (storyTasks.length === 0) return { startDate: null, endDate: null };

                const startDates = storyTasks.map(t => new Date(t.startDate)).filter(d => !isNaN(d));
                const endDates = storyTasks.map(t => new Date(t.endDate)).filter(d => !isNaN(d));

                if (startDates.length === 0 || endDates.length === 0) return { startDate: null, endDate: null };

                const minStart = new Date(Math.min(...startDates));
                const maxEnd = new Date(Math.max(...endDates));

                return {
                    startDate: minStart.toISOString().split('T')[0],
                    endDate: maxEnd.toISOString().split('T')[0]
                };
            };

            const getTaskPosition = (task) => {
                if (!task.startDate || !task.endDate) return null;
                
                const startDate = new Date(task.startDate);
                const endDate = new Date(task.endDate);
                const startYear = startDate.getFullYear();
                const endYear = endDate.getFullYear();
                const lastDisplayedYear = currentYear + yearView - 1;
                
                if (endYear < currentYear || startYear > lastDisplayedYear) return null;

                let startWeekPos = 0;
                let endWeekPos = 0;
                
                if (startYear < currentYear) {
                    startWeekPos = 0;
                } else {
                    for (let y = currentYear; y < startYear; y++) {
                        startWeekPos += getWeeksInYear(y);
                    }
                    startWeekPos += getWeekNumber(startDate);
                }
                
                if (endYear > lastDisplayedYear) {
                    for (let y = currentYear; y <= lastDisplayedYear; y++) {
                        endWeekPos += getWeeksInYear(y);
                    }
                } else {
                    for (let y = currentYear; y < endYear; y++) {
                        endWeekPos += getWeeksInYear(y);
                    }
                    endWeekPos += getWeekNumber(endDate);
                }

                const firstDisplayedWeek = weekColumns.length > 0 ? weekColumns[0].week : 1;
                let weeksBeforeFirst = 0;
                if (weekColumns[0]) {
                    for (let y = currentYear; y < weekColumns[0].year; y++) {
                        weeksBeforeFirst += getWeeksInYear(y);
                    }
                    weeksBeforeFirst += firstDisplayedWeek - 1;
                }
                
                const adjustedStart = startWeekPos - weeksBeforeFirst;
                const adjustedEnd = endWeekPos - weeksBeforeFirst;
                const width = adjustedEnd - adjustedStart + 1;
                
                return { left: Math.max(0, adjustedStart), width: Math.max(1, width) };
            };

            const exportJSON = () => {
                const data = { projectTitle, currentYear, language, yearView, tasks, teamMembers };
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `${projectTitle.replace(/\s+/g, '_')}_${currentYear}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importJSON = (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                const t = translations[language];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.projectTitle) setProjectTitle(data.projectTitle);
                        if (data.currentYear) setCurrentYear(data.currentYear);
                        if (data.tasks && Array.isArray(data.tasks)) {
                            // Ajouter le statut par défaut si manquant
                            const updatedTasks = data.tasks.map(task => ({
                                ...task,
                                status: task.status || 'todo'
                            }));
                            setTasks(updatedTasks);
                        }
                        if (data.language) setLanguage(data.language);
                        if (data.yearView) setYearView(data.yearView);
                        if (data.teamMembers && Array.isArray(data.teamMembers)) setTeamMembers(data.teamMembers);
                    } catch (error) {
                        alert(t.errorJSON);
                    }
                };
                reader.readAsText(file);
                
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const exportAsImage = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const cellWidth = 30;
                const rowHeight = 48;
                const headerHeight = 80;
                const monthHeaderHeight = 24;
                const columnHeaderHeight = 32;
                const typeColWidth = 112;
                const descColWidth = 320;
                const startColWidth = 128;
                const endColWidth = 128;
                
                const totalWidth = typeColWidth + descColWidth + startColWidth + endColWidth + (weekColumns.length * cellWidth) + 20;
                const totalHeight = headerHeight + monthHeaderHeight + columnHeaderHeight + (tasks.length * rowHeight) + 20;
                
                canvas.width = totalWidth;
                canvas.height = totalHeight;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, totalWidth, totalHeight);
                
                const gradient = ctx.createLinearGradient(0, 0, totalWidth, 0);
                gradient.addColorStop(0, '#2563eb');
                gradient.addColorStop(1, '#1d4ed8');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, totalWidth, headerHeight);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 24px Arial';
                ctx.fillText(projectTitle, 20, 35);
                ctx.font = 'bold 20px Arial';
                const yearText = yearView === 1 ? currentYear.toString() : `${currentYear}-${currentYear + yearView - 1}`;
                ctx.fillText(yearText, 20, 65);
                
                let yOffset = headerHeight;
                
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, yOffset, totalWidth, monthHeaderHeight);
                
                const weekStartX = typeColWidth + descColWidth + startColWidth + endColWidth;
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 11px Arial';
                
                let currentMonth = '';
                let monthStartIdx = 0;
                weekColumns.forEach((col, idx) => {
                    const monthYearKey = `${col.month}-${col.year}`;
                    if (monthYearKey !== currentMonth) {
                        if (currentMonth !== '') {
                            const monthWidth = (idx - monthStartIdx) * cellWidth;
                            const x = weekStartX + (monthStartIdx * cellWidth);
                            const prevCol = weekColumns[monthStartIdx];
                            const label = yearView > 1 ? `${prevCol.month} ${prevCol.year}` : prevCol.month;
                            ctx.fillText(label, x + monthWidth / 2 - ctx.measureText(label).width / 2, yOffset + 16);
                        }
                        currentMonth = monthYearKey;
                        monthStartIdx = idx;
                    }
                    if (idx === weekColumns.length - 1) {
                        const monthWidth = (idx - monthStartIdx + 1) * cellWidth;
                        const x = weekStartX + (monthStartIdx * cellWidth);
                        const label = yearView > 1 ? `${col.month} ${col.year}` : col.month;
                        ctx.fillText(label, x + monthWidth / 2 - ctx.measureText(label).width / 2, yOffset + 16);
                    }
                });
                
                yOffset += monthHeaderHeight;
                
                ctx.fillStyle = '#f9fafb';
                ctx.fillRect(0, yOffset, totalWidth, columnHeaderHeight);
                
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 14px Arial';
                const t = translations[language];
                ctx.fillText(t.type, 10, yOffset + 20);
                ctx.fillText(t.description, typeColWidth + 10, yOffset + 20);
                ctx.fillText(t.start, typeColWidth + descColWidth + 10, yOffset + 20);
                ctx.fillText(t.end, typeColWidth + descColWidth + startColWidth + 10, yOffset + 20);
                
                ctx.font = '11px Arial';
                ctx.fillStyle = '#4b5563';
                
                weekColumns.forEach((col, idx) => {
                    const x = weekStartX + (idx * cellWidth);
                    ctx.fillText(col.week.toString(), x + cellWidth/2 - 6, yOffset + 20);
                    
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.beginPath();
                    ctx.moveTo(x, yOffset);
                    ctx.lineTo(x, totalHeight);
                    ctx.stroke();
                });
                
                yOffset += columnHeaderHeight;
                
                tasks.forEach((task, taskIdx) => {
                    const y = yOffset + (taskIdx * rowHeight);
                    
                    const isStory = task.type === 'Story';
                    const storyDates = isStory ? getStoryDatesFromList(tasks, taskIdx) : null;
                    const displayStartDate = isStory ? storyDates?.startDate : task.startDate;
                    const displayEndDate = isStory ? storyDates?.endDate : task.endDate;
                    const taskToDisplay = isStory ? { ...task, startDate: displayStartDate, endDate: displayEndDate } : task;
                    const assignee = task.assigneeId ? getMemberById(task.assigneeId) : null;
                    
                    if (taskIdx % 2 === 0) {
                        ctx.fillStyle = '#ffffff';
                    } else {
                        ctx.fillStyle = '#f9fafb';
                    }
                    ctx.fillRect(0, y, totalWidth, rowHeight);
                    
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(totalWidth, y);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#000000';
                    ctx.font = '13px Arial';
                    ctx.fillText(task.type, 10, y + 28);
                    ctx.fillText(task.description.length > 35 ? task.description.substring(0, 35) + '...' : task.description, typeColWidth + 10, y + 28);
                    ctx.fillText(displayStartDate ? formatDate(displayStartDate) : '-', typeColWidth + descColWidth + 10, y + 28);
                    ctx.fillText(displayEndDate ? formatDate(displayEndDate) : '-', typeColWidth + descColWidth + startColWidth + 10, y + 28);
                    
                    const position = getTaskPosition(taskToDisplay);
                    if (position && displayStartDate && displayEndDate) {
                        const barX = weekStartX + (position.left * cellWidth);
                        const barWidth = position.width * cellWidth;
                        const barY = y + 8;
                        const barHeight = rowHeight - 16;
                        
                        ctx.fillStyle = task.color;
                        ctx.beginPath();
                        ctx.roundRect(barX + 2, barY, barWidth - 4, barHeight, 4);
                        ctx.fill();
                        
                        // Afficher les initiales si assigné
                        if (assignee) {
                            ctx.fillStyle = '#ffffff';
                            ctx.beginPath();
                            ctx.arc(barX + 8, barY + 6, 10, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.strokeStyle = task.color;
                            ctx.lineWidth = 2;
                            ctx.stroke();
                            ctx.lineWidth = 1;
                            ctx.fillStyle = task.color;
                            ctx.font = 'bold 8px Arial';
                            const initials = getInitials(assignee.name);
                            ctx.fillText(initials, barX + 8 - ctx.measureText(initials).width / 2, barY + 10);
                        }
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 10px Arial';
                        const text = `${formatDate(displayStartDate)} - ${formatDate(displayEndDate)}`;
                        const textWidth = ctx.measureText(text).width;
                        if (barWidth > textWidth + 10) {
                            ctx.fillText(text, barX + (barWidth - textWidth) / 2, y + 30);
                        }
                    }
                });
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `${projectTitle.replace(/\s+/g, '_')}_${currentYear}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                });
            };

            return (
                <div className="min-h-screen bg-gray-50 p-2 sm:p-4 md:p-6">
                    <input ref={fileInputRef} type="file" accept=".json" onChange={importJSON} style={{ display: 'none' }} />
                    
                    <div className="max-w-[100vw] mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-3 sm:p-4 md:p-6">
                            <div className="flex items-center justify-between flex-wrap gap-2">
                                <div className="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                    <Calendar size={20} className="text-white flex-shrink-0" />
                                    <input
                                        type="text"
                                        value={projectTitle}
                                        onChange={(e) => setProjectTitle(e.target.value)}
                                        className="text-lg sm:text-xl md:text-2xl font-bold bg-transparent text-white border-b-2 border-transparent hover:border-white/50 focus:border-white focus:outline-none transition-colors px-1 sm:px-2 flex-1 min-w-0"
                                        placeholder={translations[language].projectTitle}
                                    />
                                </div>
                                
                                <button
                                    onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                                    className="lg:hidden p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors"
                                >
                                    {mobileMenuOpen ? <X size={24} /> : <Menu size={24} />}
                                </button>

                                <div className="hidden lg:flex items-center gap-2 xl:gap-3">
                                    <select
                                        value={language}
                                        onChange={(e) => setLanguage(e.target.value)}
                                        className="bg-white/20 text-white text-sm font-medium px-3 py-2 rounded-lg focus:outline-none cursor-pointer hover:bg-white/30 transition-colors"
                                    >
                                        <option value="fr" className="text-gray-900">FR</option>
                                        <option value="en" className="text-gray-900">EN</option>
                                        <option value="ro" className="text-gray-900">RO</option>
                                    </select>

                                    <button
                                        onClick={() => setShowColumns(!showColumns)}
                                        className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors"
                                        title={showColumns ? translations[language].hideColumns : translations[language].showColumns}
                                    >
                                        {showColumns ? <Eye size={20} /> : <EyeOff size={20} />}
                                    </button>

                                    <div className="h-6 w-px bg-white/30"></div>

                                    <div className="relative">
                                        <button 
                                            onClick={() => setStatsMenuOpen(!statsMenuOpen)}
                                            className="flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors text-sm font-medium"
                                        >
                                            <BarChart size={18} />
                                            {translations[language].statistics}
                                        </button>
                                        {statsMenuOpen && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setStatsMenuOpen(false)}></div>
                                                <div className="absolute right-0 mt-2 w-[600px] bg-white rounded-lg shadow-xl z-50 p-6 max-h-[80vh] overflow-y-auto">
                                                    <h3 className="font-bold text-xl text-gray-800 mb-4">{translations[language].statistics}</h3>
                                                    
                                                    {/* Durée du projet */}
                                                    <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                                        <h4 className="font-semibold text-gray-700 mb-2">{translations[language].projectDuration}</h4>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div>
                                                                <p className="text-3xl font-bold text-blue-600">
                                                                    {calculateProjectDuration().days}
                                                                </p>
                                                                <p className="text-sm text-gray-600">{translations[language].days}</p>
                                                            </div>
                                                            <div>
                                                                <p className="text-3xl font-bold text-blue-600">
                                                                    {calculateProjectDuration().weeks}
                                                                </p>
                                                                <p className="text-sm text-gray-600">{translations[language].weeks}</p>
                                                            </div>
                                                        </div>
                                                        {calculateProjectDuration().startDate && (
                                                            <div className="mt-3 text-xs text-gray-600">
                                                                <p>{translations[language].startDate}: {formatDate(calculateProjectDuration().startDate.toISOString().split('T')[0])}</p>
                                                                <p>{translations[language].endDate}: {formatDate(calculateProjectDuration().endDate.toISOString().split('T')[0])}</p>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* Progression */}
                                                    <div className="mb-6 p-4 bg-green-50 rounded-lg">
                                                        <h4 className="font-semibold text-gray-700 mb-2">{translations[language].progressChart}</h4>
                                                        <div className="mb-3">
                                                            <div className="flex justify-between text-sm mb-1">
                                                                <span className="text-gray-600">{translations[language].completionRate}</span>
                                                                <span className="font-bold text-green-600">{calculateProgress().percentage}%</span>
                                                            </div>
                                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                                <div 
                                                                    className="bg-green-500 h-4 rounded-full transition-all duration-500"
                                                                    style={{ width: `${calculateProgress().percentage}%` }}
                                                                ></div>
                                                            </div>
                                                            <p className="text-xs text-gray-600 mt-1">
                                                                {calculateProgress().completed} / {calculateProgress().total} {translations[language].totalTasks}
                                                            </p>
                                                        </div>
                                                        
                                                        <div className="grid grid-cols-4 gap-2 mt-4">
                                                            <div className="text-center p-2 bg-white rounded">
                                                                <p className="text-lg font-bold text-gray-600">{getStatusCount().todo}</p>
                                                                <p className="text-xs text-gray-500">{translations[language].todo}</p>
                                                            </div>
                                                            <div className="text-center p-2 bg-white rounded">
                                                                <p className="text-lg font-bold text-blue-600">{getStatusCount().inProgress}</p>
                                                                <p className="text-xs text-gray-500">{translations[language].inProgress}</p>
                                                            </div>
                                                            <div className="text-center p-2 bg-white rounded">
                                                                <p className="text-lg font-bold text-green-600">{getStatusCount().completed}</p>
                                                                <p className="text-xs text-gray-500">{translations[language].completed}</p>
                                                            </div>
                                                            <div className="text-center p-2 bg-white rounded">
                                                                <p className="text-lg font-bold text-red-600">{getStatusCount().blocked}</p>
                                                                <p className="text-xs text-gray-500">{translations[language].blocked}</p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Tâches en retard */}
                                                    <div className="mb-6 p-4 bg-red-50 rounded-lg">
                                                        <h4 className="font-semibold text-gray-700 mb-2">{translations[language].overdueTasks}</h4>
                                                        {getOverdueTasks().length === 0 ? (
                                                            <p className="text-green-600 font-medium">✓ {translations[language].noOverdue}</p>
                                                        ) : (
                                                            <div className="space-y-2">
                                                                <p className="text-2xl font-bold text-red-600 mb-3">{getOverdueTasks().length}</p>
                                                                {getOverdueTasks().map(task => (
                                                                    <div key={task.id} className="bg-white p-2 rounded border-l-4 border-red-500">
                                                                        <p className="font-medium text-sm text-gray-800">{task.description}</p>
                                                                        <p className="text-xs text-gray-600">
                                                                            {translations[language].endDate}: {formatDate(task.endDate)}
                                                                        </p>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* Charge de travail */}
                                                    <div className="mb-4 p-4 bg-purple-50 rounded-lg">
                                                        <h4 className="font-semibold text-gray-700 mb-3">{translations[language].workloadByWeek}</h4>
                                                        <div className="space-y-2 max-h-60 overflow-y-auto">
                                                            {Object.entries(calculateWorkloadByWeek())
                                                                .sort(([a], [b]) => a.localeCompare(b))
                                                                .map(([week, count]) => (
                                                                    <div key={week} className="flex items-center gap-3">
                                                                        <span className="text-xs text-gray-600 w-20">{week}</span>
                                                                        <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                                                                            <div 
                                                                                className="bg-purple-500 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold"
                                                                                style={{ width: `${(count / Math.max(...Object.values(calculateWorkloadByWeek()))) * 100}%`, minWidth: '30px' }}
                                                                            >
                                                                                {count}
                                                                            </div>
                                                                        </div>
                                                                        <span className="text-xs text-gray-600 w-24">{count} {translations[language].tasksActive}</span>
                                                                    </div>
                                                                ))
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </div>

                                    <div className="h-6 w-px bg-white/30"></div>

                                    <div className="relative">
                                        <button 
                                            onClick={() => setTeamMenuOpen(!teamMenuOpen)}
                                            className="flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors text-sm font-medium"
                                        >
                                            <Users size={18} />
                                            {translations[language].manageTeam}
                                        </button>
                                        {teamMenuOpen && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setTeamMenuOpen(false)}></div>
                                                <div className="absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-50 p-4">
                                                    <h3 className="font-bold text-gray-800 mb-3">{translations[language].manageTeam}</h3>
                                                    
                                                    <div className="flex gap-2 mb-3">
                                                        <input
                                                            type="text"
                                                            value={newMemberName}
                                                            onChange={(e) => setNewMemberName(e.target.value)}
                                                            onKeyPress={(e) => e.key === 'Enter' && addTeamMember()}
                                                            placeholder={translations[language].memberName}
                                                            className="flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        />
                                                        <button
                                                            onClick={addTeamMember}
                                                            className="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
                                                        >
                                                            <UserPlus size={18} />
                                                        </button>
                                                    </div>
                                                    
                                                    <div className="max-h-60 overflow-y-auto space-y-2">
                                                        {teamMembers.map(member => (
                                                            <div key={member.id} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold">
                                                                        {getInitials(member.name)}
                                                                    </div>
                                                                    <span className="text-sm text-gray-700">{member.name}</span>
                                                                </div>
                                                                <button
                                                                    onClick={() => deleteTeamMember(member.id)}
                                                                    className="p-1 hover:bg-red-100 rounded text-red-600 transition-colors"
                                                                    title={translations[language].deleteMember}
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </div>
                                                        ))}
                                                        {teamMembers.length === 0 && (
                                                            <p className="text-sm text-gray-500 text-center py-4">{translations[language].addMember}</p>
                                                        )}
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </div>

                                    <div className="relative">
                                        <button 
                                            onClick={() => setFilterMenuOpen(!filterMenuOpen)}
                                            className="flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors text-sm font-medium"
                                        >
                                            <Filter size={18} />
                                            {translations[language].filterByMember}
                                        </button>
                                        {filterMenuOpen && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setFilterMenuOpen(false)}></div>
                                                <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl z-50 py-2">
                                                    <button
                                                        onClick={() => { setSelectedMemberFilter('all'); setFilterMenuOpen(false); }}
                                                        className={`w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-100 text-sm transition-colors text-left ${selectedMemberFilter === 'all' ? 'bg-blue-50 text-blue-600' : 'text-gray-700'}`}
                                                    >
                                                        {translations[language].allMembers}
                                                    </button>
                                                    <button
                                                        onClick={() => { setSelectedMemberFilter('unassigned'); setFilterMenuOpen(false); }}
                                                        className={`w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-100 text-sm transition-colors text-left ${selectedMemberFilter === 'unassigned' ? 'bg-blue-50 text-blue-600' : 'text-gray-700'}`}
                                                    >
                                                        {translations[language].noAssignee}
                                                    </button>
                                                    {teamMembers.length > 0 && <div className="border-t my-1"></div>}
                                                    {teamMembers.map(member => (
                                                        <button
                                                            key={member.id}
                                                            onClick={() => { setSelectedMemberFilter(member.id.toString()); setFilterMenuOpen(false); }}
                                                            className={`w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-100 text-sm transition-colors text-left ${selectedMemberFilter === member.id.toString() ? 'bg-blue-50 text-blue-600' : 'text-gray-700'}`}
                                                        >
                                                            <div className="w-6 h-6 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold">
                                                                {getInitials(member.name)}
                                                            </div>
                                                            {member.name}
                                                        </button>
                                                    ))}
                                                </div>
                                            </>
                                        )}
                                    </div>

                                    <div className="h-6 w-px bg-white/30"></div>

                                    <button onClick={() => setCurrentYear(currentYear - 1)} className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors">
                                        <ChevronLeft size={20} />
                                    </button>
                                    <span className="text-lg font-bold text-white min-w-[90px] text-center">
                                        {yearView === 1 ? currentYear : `${currentYear}-${currentYear + yearView - 1}`}
                                    </span>
                                    <button onClick={() => setCurrentYear(currentYear + 1)} className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors">
                                        <ChevronRight size={20} />
                                    </button>

                                    <div className="h-6 w-px bg-white/30"></div>

                                    <select
                                        value={yearView}
                                        onChange={(e) => setYearView(parseInt(e.target.value))}
                                        className="bg-white/20 text-white text-sm font-medium px-3 py-2 rounded-lg focus:outline-none cursor-pointer hover:bg-white/30 transition-colors"
                                    >
                                        <option value="1" className="text-gray-900">📅 {translations[language].oneYear}</option>
                                        <option value="2" className="text-gray-900">📅 {translations[language].twoYears}</option>
                                        <option value="3" className="text-gray-900">📅 {translations[language].threeYears}</option>
                                    </select>

                                    <div className="h-6 w-px bg-white/30"></div>

                                    <div className="relative">
                                        <button 
                                            onClick={() => setFileMenuOpen(!fileMenuOpen)}
                                            className="flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors text-sm font-medium"
                                        >
                                            📁 {translations[language].file}
                                        </button>
                                        {fileMenuOpen && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setFileMenuOpen(false)}></div>
                                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-50">
                                                    <button
                                                        onClick={() => { exportJSON(); setFileMenuOpen(false); }}
                                                        className="w-full flex items-center gap-2 px-4 py-3 hover:bg-gray-100 text-gray-700 text-sm transition-colors rounded-t-lg text-left"
                                                    >
                                                        <FileDown size={18} />
                                                        {translations[language].exportJSON}
                                                    </button>
                                                    <button
                                                        onClick={() => { fileInputRef.current?.click(); setFileMenuOpen(false); }}
                                                        className="w-full flex items-center gap-2 px-4 py-3 hover:bg-gray-100 text-gray-700 text-sm transition-colors text-left"
                                                    >
                                                        <Upload size={18} />
                                                        {translations[language].importJSON}
                                                    </button>
                                                    <button
                                                        onClick={() => { exportAsImage(); setFileMenuOpen(false); }}
                                                        className="w-full flex items-center gap-2 px-4 py-3 hover:bg-gray-100 text-gray-700 text-sm transition-colors rounded-b-lg text-left"
                                                    >
                                                        <Download size={18} />
                                                        {translations[language].exportImage}
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                    </div>

                                    <div className="h-6 w-px bg-white/30"></div>

                                    <button
                                        onClick={addTask}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors text-sm font-medium"
                                    >
                                        <Plus size={18} />
                                        {translations[language].addTask}
                                    </button>
                                </div>
                            </div>

                            {mobileMenuOpen && (
                                <div className="lg:hidden mt-4 space-y-2 border-t border-white/20 pt-4">
                                    <div className="flex items-center justify-between gap-2">
                                        <select
                                            value={language}
                                            onChange={(e) => setLanguage(e.target.value)}
                                            className="bg-white/20 text-white text-sm font-medium px-3 py-2 rounded-lg focus:outline-none flex-1"
                                        >
                                            <option value="fr" className="text-gray-900">Français</option>
                                            <option value="en" className="text-gray-900">English</option>
                                            <option value="ro" className="text-gray-900">Română</option>
                                        </select>
                                        <button
                                            onClick={() => setShowColumns(!showColumns)}
                                            className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors"
                                        >
                                            {showColumns ? <Eye size={20} /> : <EyeOff size={20} />}
                                        </button>
                                    </div>
                                    
                                    <div className="flex items-center justify-center gap-2 bg-white/20 rounded-lg p-2">
                                        <button onClick={() => setCurrentYear(currentYear - 1)} className="p-2 hover:bg-white/30 rounded-lg transition-colors">
                                            <ChevronLeft size={20} />
                                        </button>
                                        <span className="text-base font-bold text-white min-w-[100px] text-center">
                                            {yearView === 1 ? currentYear : `${currentYear}-${currentYear + yearView - 1}`}
                                        </span>
                                        <button onClick={() => setCurrentYear(currentYear + 1)} className="p-2 hover:bg-white/30 rounded-lg transition-colors">
                                            <ChevronRight size={20} />
                                        </button>
                                    </div>

                                    <select
                                        value={yearView}
                                        onChange={(e) => setYearView(parseInt(e.target.value))}
                                        className="w-full bg-white/20 text-white text-sm font-medium px-3 py-2 rounded-lg focus:outline-none"
                                    >
                                        <option value="1" className="text-gray-900">📅 {translations[language].oneYear}</option>
                                        <option value="2" className="text-gray-900">📅 {translations[language].twoYears}</option>
                                        <option value="3" className="text-gray-900">📅 {translations[language].threeYears}</option>
                                    </select>

                                    <button
                                        onClick={() => { addTask(); setMobileMenuOpen(false); }}
                                        className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors"
                                    >
                                        <Plus size={20} />
                                        {translations[language].addTask}
                                    </button>
                                    
                                    <div className="grid grid-cols-3 gap-2">
                                        <button
                                            onClick={() => { exportJSON(); setMobileMenuOpen(false); }}
                                            className="flex flex-col items-center gap-1 px-2 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-xs"
                                        >
                                            <FileDown size={20} />
                                            <span>JSON</span>
                                        </button>
                                        <button
                                            onClick={() => { fileInputRef.current?.click(); setMobileMenuOpen(false); }}
                                            className="flex flex-col items-center gap-1 px-2 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors text-xs"
                                        >
                                            <Upload size={20} />
                                            <span>Import</span>
                                        </button>
                                        <button
                                            onClick={() => { exportAsImage(); setMobileMenuOpen(false); }}
                                            className="flex flex-col items-center gap-1 px-2 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors text-xs"
                                        >
                                            <Download size={20} />
                                            <span>Image</span>
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex overflow-hidden">
                            <div className="flex-shrink-0 bg-white border-r-2 border-gray-300">
                                <div className="flex border-b-2 border-gray-200 bg-gray-50">
                                    {showColumns && <div className="w-16 sm:w-20 md:w-28 p-2 sm:p-3 font-bold text-gray-700 border-r text-xs sm:text-sm">{translations[language].type}</div>}
                                    <div className="w-40 sm:w-60 md:w-80 p-2 sm:p-3 font-bold text-gray-700 border-r text-xs sm:text-sm">{translations[language].description}</div>
                                    {showColumns && <div className="w-28 md:w-36 p-2 sm:p-3 font-bold text-gray-700 border-r text-xs sm:text-sm">{translations[language].status}</div>}
                                    {showColumns && <div className="w-32 md:w-40 p-2 sm:p-3 font-bold text-gray-700 border-r text-xs sm:text-sm">{translations[language].assignee}</div>}
                                    {showColumns && <div className="w-24 md:w-32 p-2 sm:p-3 font-bold text-gray-700 border-r text-xs sm:text-sm">{translations[language].start}</div>}
                                    {showColumns && <div className="w-24 md:w-32 p-2 sm:p-3 font-bold text-gray-700 border-r text-xs sm:text-sm">{translations[language].end}</div>}
                                    {showColumns && <div className="w-24 sm:w-28 p-2 sm:p-3 font-bold text-gray-700 text-xs sm:text-sm text-center">{translations[language].action}</div>}
                                </div>

                                {filteredTasks.map((task, taskIndex) => {
                                    const isStory = task.type === 'Story';
                                    const storyDates = isStory ? getStoryDates(taskIndex) : null;
                                    const displayStartDate = isStory ? storyDates?.startDate : task.startDate;
                                    const displayEndDate = isStory ? storyDates?.endDate : task.endDate;
                                    
                                    return (
                                        <div key={`fixed-${task.id}`} className="flex border-b border-gray-200 hover:bg-gray-50" style={{ height: '48px' }}>
                                            {showColumns && (
                                                <div className="w-16 sm:w-20 md:w-28 p-1 sm:p-2 border-r flex items-center justify-center">
                                                    <select
                                                        value={task.type}
                                                        onChange={(e) => updateTask(task.id, 'type', e.target.value)}
                                                        className="w-full px-1 py-1 border rounded text-xs"
                                                    >
                                                        <option value="Story">{translations[language].story}</option>
                                                        <option value="Task">{translations[language].task}</option>
                                                    </select>
                                                </div>
                                            )}
                                            <div className="w-40 sm:w-60 md:w-80 p-1 sm:p-2 border-r">
                                                <input
                                                    type="text"
                                                    value={task.description}
                                                    onChange={(e) => updateTask(task.id, 'description', e.target.value)}
                                                    className="w-full px-1 sm:px-2 py-1 border rounded text-xs sm:text-sm"
                                                />
                                            </div>
                                            {showColumns && (
                                                <div className="w-28 md:w-36 p-1 sm:p-2 border-r">
                                                    <select
                                                        value={task.status || 'todo'}
                                                        onChange={(e) => updateTask(task.id, 'status', e.target.value)}
                                                        className="w-full px-1 py-1 border rounded text-xs"
                                                        style={{
                                                            backgroundColor: 
                                                                task.status === 'completed' ? '#dcfce7' :
                                                                task.status === 'inProgress' ? '#dbeafe' :
                                                                task.status === 'blocked' ? '#fee2e2' : '#f3f4f6'
                                                        }}
                                                    >
                                                        <option value="todo">{translations[language].todo}</option>
                                                        <option value="inProgress">{translations[language].inProgress}</option>
                                                        <option value="completed">{translations[language].completed}</option>
                                                        <option value="blocked">{translations[language].blocked}</option>
                                                    </select>
                                                </div>
                                            )}
                                            {showColumns && (
                                                <div className="w-32 md:w-40 p-1 sm:p-2 border-r">
                                                    <select
                                                        value={task.assigneeId || ''}
                                                        onChange={(e) => updateTask(task.id, 'assigneeId', e.target.value ? parseInt(e.target.value) : null)}
                                                        className="w-full px-1 py-1 border rounded text-xs"
                                                    >
                                                        <option value="">{translations[language].noAssignee}</option>
                                                        {teamMembers.map(member => (
                                                            <option key={member.id} value={member.id}>{member.name}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                            {showColumns && (
                                                <div className="w-24 md:w-32 p-1 sm:p-2 border-r">
                                                    {isStory ? (
                                                        <div className="px-1 sm:px-2 py-1 text-xs sm:text-sm text-gray-600 bg-gray-100 rounded border truncate">
                                                            {displayStartDate ? formatDate(displayStartDate) : '-'}
                                                        </div>
                                                    ) : (
                                                        <input
                                                            type="date"
                                                            value={task.startDate}
                                                            onChange={(e) => updateTask(task.id, 'startDate', e.target.value)}
                                                            className="w-full px-1 py-1 border rounded text-xs"
                                                        />
                                                    )}
                                                </div>
                                            )}
                                            {showColumns && (
                                                <div className="w-24 md:w-32 p-1 sm:p-2 border-r">
                                                    {isStory ? (
                                                        <div className="px-1 sm:px-2 py-1 text-xs sm:text-sm text-gray-600 bg-gray-100 rounded border truncate">
                                                            {displayEndDate ? formatDate(displayEndDate) : '-'}
                                                        </div>
                                                    ) : (
                                                        <input
                                                            type="date"
                                                            value={task.endDate}
                                                            onChange={(e) => updateTask(task.id, 'endDate', e.target.value)}
                                                            className="w-full px-1 py-1 border rounded text-xs"
                                                        />
                                                    )}
                                                </div>
                                            )}
                                            {showColumns && (
                                                <div className="w-24 sm:w-28 flex items-center justify-center gap-1 p-1 sm:p-2">
                                                    <div className="relative">
                                                        <button
                                                            onClick={() => setColorPickerOpen(colorPickerOpen === task.id ? null : task.id)}
                                                            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                                                            title={translations[language].color}
                                                            style={{ color: task.color }}
                                                        >
                                                            <Palette size={18} />
                                                        </button>
                                                        {colorPickerOpen === task.id && (
                                                            <>
                                                                <div className="fixed inset-0 z-40" onClick={() => setColorPickerOpen(null)}></div>
                                                                <div className="absolute right-0 mt-1 bg-white rounded-lg shadow-xl z-50 p-3 border" style={{ width: '200px' }}>
                                                                    <div className="grid grid-cols-4 gap-2 mb-2">
                                                                        {predefinedColors.map((color, idx) => (
                                                                            <button
                                                                                key={idx}
                                                                                onClick={() => {
                                                                                    updateTask(task.id, 'color', color);
                                                                                    setColorPickerOpen(null);
                                                                                }}
                                                                                className="w-10 h-10 rounded-lg border-2 hover:scale-110 transition-transform"
                                                                                style={{ 
                                                                                    backgroundColor: color,
                                                                                    borderColor: task.color === color ? '#000' : '#ddd'
                                                                                }}
                                                                            />
                                                                        ))}
                                                                    </div>
                                                                    <div className="border-t pt-2">
                                                                        <label className="block text-xs text-gray-600 mb-1">{translations[language].customColor}</label>
                                                                        <input
                                                                            type="color"
                                                                            value={task.color}
                                                                            onChange={(e) => updateTask(task.id, 'color', e.target.value)}
                                                                            className="w-full h-10 rounded border cursor-pointer"
                                                                        />
                                                                    </div>
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => deleteTask(task.id)}
                                                        className="p-2 hover:bg-red-100 rounded-lg text-red-600 transition-colors"
                                                        title="Supprimer"
                                                    >
                                                        <Trash2 size={18} />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>

                            <div className="flex-1 overflow-x-auto">
                                <div className="inline-block min-w-full">
                                    <div className="border-b-2 border-gray-200 bg-gray-50">
                                        <div className="flex flex-col">
                                            <div className="flex h-5 sm:h-6 border-b">
                                                {weekColumns.map((col, idx) => {
                                                    const showMonth = idx === 0 || col.month !== weekColumns[idx - 1]?.month || col.year !== weekColumns[idx - 1]?.year;
                                                    const monthSpan = showMonth ? weekColumns.filter((w, i) => i >= idx && w.month === col.month && w.year === col.year).length : 0;
                                                    
                                                    if (showMonth) {
                                                        return (
                                                            <div 
                                                                key={`month-${idx}`} 
                                                                className="text-[10px] sm:text-xs font-bold text-gray-700 flex items-center justify-center border-l bg-gray-100"
                                                                style={{ width: `${monthSpan * 30}px` }}
                                                            >
                                                                {yearView > 1 ? `${col.month} ${col.year}` : col.month}
                                                            </div>
                                                        );
                                                    }
                                                    return null;
                                                })}
                                            </div>
                                            <div className="flex h-6 sm:h-8">
                                                {weekColumns.map((col, idx) => (
                                                    <div key={idx} className="relative" style={{ width: '30px' }}>
                                                        <div className="h-full flex items-center justify-center text-[10px] sm:text-xs font-medium text-gray-600 border-l">
                                                            {col.week}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    {filteredTasks.map((task, taskIndex) => {
                                        const isStory = task.type === 'Story';
                                        const storyDates = isStory ? getStoryDates(taskIndex) : null;
                                        const displayStartDate = isStory ? storyDates?.startDate : task.startDate;
                                        const displayEndDate = isStory ? storyDates?.endDate : task.endDate;
                                        
                                        const taskToDisplay = isStory ? { ...task, startDate: displayStartDate, endDate: displayEndDate } : task;
                                        const position = getTaskPosition(taskToDisplay);
                                        const assignee = task.assigneeId ? getMemberById(task.assigneeId) : null;
                                        
                                        // Vérifier si la tâche est en retard
                                        const today = new Date();
                                        today.setHours(0, 0, 0, 0);
                                        const isOverdue = task.endDate && new Date(task.endDate) < today && task.status !== 'completed';
                                        
                                        return (
                                            <div key={`gantt-${task.id}`} className="border-b border-gray-200 hover:bg-gray-50" style={{ height: '48px' }}>
                                                <div className="relative" style={{ height: '48px' }}>
                                                    <div className="absolute inset-0 flex">
                                                        {weekColumns.map((_, idx) => (
                                                            <div key={idx} className="border-l" style={{ width: '30px', height: '100%' }} />
                                                        ))}
                                                    </div>
                                                    {position && (
                                                        <div
                                                            className="absolute top-2 bottom-2 rounded flex items-center justify-center text-white text-[8px] sm:text-xs font-medium shadow-md cursor-pointer hover:opacity-90 transition-opacity px-1"
                                                            style={{
                                                                left: `${position.left * 30}px`,
                                                                width: `${position.width * 30}px`,
                                                                backgroundColor: task.color,
                                                                border: isOverdue ? '3px solid #ef4444' : 'none',
                                                                boxShadow: isOverdue ? '0 0 10px rgba(239, 68, 68, 0.5)' : undefined
                                                            }}
                                                        >
                                                            {assignee && (
                                                                <div className="absolute -top-1 -left-1 w-6 h-6 rounded-full bg-white border-2 flex items-center justify-center text-[10px] font-bold shadow-sm" style={{ borderColor: task.color, color: task.color }}>
                                                                    {getInitials(assignee.name)}
                                                                </div>
                                                            )}
                                                            <span className="truncate hidden sm:inline">
                                                                {displayStartDate && displayEndDate ? `${formatDate(displayStartDate)} - ${formatDate(displayEndDate)}` : ''}
                                                            </span>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        <div className="bg-gray-50 p-2 sm:p-3 md:p-4 border-t">
                            <p className="text-xs sm:text-sm text-gray-600 text-center">
                                {filteredTasks.length} {translations[language].taskCount} • {yearView === 1 ? `${translations[language].year} ${currentYear}` : `${currentYear}-${currentYear + yearView - 1}`}
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProjectPlanner />);
    </script>
</body>
</html>
